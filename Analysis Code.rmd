# Data Analysis Code
```{r}
library(ggplot2)
library(dplyr)
library(maps)
library(lubridate) 
library(plotly)
library(stringr)
library(scales)
```

```{r}
## Import Data
df <- read.csv("giftcard_purchases_data.csv")
```

```{r}
summary(df)
```

### Remove Quantity Outliers
```{r}
filt_quant <- df %>%
  filter(Quantity <= quantile(Quantity, 0.99, na.rm = TRUE))
```
Following the analysis by **Berke et al. (2024)** in *Nature Scientific Data*, which identified the top 1% of gift card purchasers as extreme outliers, further inspection of the present dataset revealed a single order containing 64 gift cardsâ€”substantially exceeding typical purchasing behavior. To ensure data integrity and prevent skewness in subsequent analyses, transactions exceeding the 99th percentile of purchase quantity were excluded.

### Remove Price Outliers
```{r}
filt_price <- df %>%
  filter(`Purchase.Price.Per.Unit` > 1)
```
The dataset included 4,507 anomalous transactions where the purchase price per unit was less than $1, the quantity was exactly one, and the total price equaled the unit price. This pattern is inconsistent with genuine retail purchases and is characteristic of system-generated activities, such as account reloads, payment method tests, or fraudulent micro-transactions used to validate stolen credit cards. To ensure the analytical integrity of the dataset and to focus on meaningful consumer purchasing behavior, these non-representative records were removed, retaining a robust sample of 41,034 observations for analysis. 

## Time Series Analysis
```{r}
## Filtering Orders by Date
df_time <- filt_quant %>%
  filter(as.Date(`Order.Date`) < as.Date("2023-01-01"))
```

```{r}
## Yearly Sales Trend Plot
df_time %>%
  mutate(Order_Year = year(as.Date(`Order.Date`))) %>%
  group_by(Order_Year) %>%
  summarise(Total_Quantity = sum(Quantity, na.rm = TRUE)) %>%
  ggplot(aes(x = Order_Year, y = Total_Quantity)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(color = "steelblue", size = 2) +
  labs(title = "Gift Card Sales Trend by Year", x = "Order Year", y = "Total Quantity") +
  theme_minimal() +
  theme(plot.background = element_rect(fill = "white"),
        aspect.ratio = 0.8) 
```

```{r}
## Quarterly Sales Visualization
df_time %>%
  mutate(Quarter = quarter(`Order.Date`),
         Year = year(`Order.Date`),
         YearQuarter = paste("Q", Quarter, sep = "")) %>%
  group_by(Year, Quarter, YearQuarter) %>%
  summarise(TotalQuantity = sum(Quantity)) %>%
  ggplot(aes(x = Quarter, y = TotalQuantity, group = 1)) +
  geom_line(color = "steelblue", size = 1) +
  geom_point(color = "steelblue", size = 2) +
  facet_wrap(~ Year, scales = "free_x") +
  labs(title = "Quarterly Gift Card Sales on Amazon - By Year",
       x = "Quarter",
       y = "Total Quantity Sold") +
  theme_minimal()
```

```{r}
## Monthly Sales Distribution
df_time %>%
  mutate(Month = month(`Order.Date`, label = TRUE, abbr = TRUE)) %>%
  group_by(Month) %>%
  summarise(Avg_Quantity = sum(Quantity)) %>%
  ggplot(aes(x = Month, y = Avg_Quantity)) +
  geom_col(fill = "steelblue", alpha = 0.8, width = 0.7) +
  labs(
    title = "Monthly Distribution of Gift Card Sales",
    subtitle = "Average Quantity Across All Years",
    x = "Month",
    y = "Average Quantity"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 10)
  )
```


## Regional Pattern
```{r}
plot_ly(
  data = filt_quant %>%
    group_by(`Q.demos.state`) %>%
    summarise(Total_Qty = sum(Quantity, na.rm = TRUE)) %>%
    mutate(abbr = state.abb[match(`Q.demos.state`, state.name)]),
  type = "choropleth",
  locations = ~abbr,
  locationmode = "USA-states",
  z = ~Total_Qty,
  colorscale = "Viridis",
  colorbar = list(title = "Quantity"),
  marker = list(line = list(color = "white", width = 1))
) %>%
  layout(
    title = "Gift Card Purchases by State",
    geo = list(scope = 'usa')
  )
```


## Gender Pattern
```{r}
df_gender_summary <- filt_quant %>%
  group_by(`Q.demos.gender`) %>%
  summarise(total_quantity = sum(Quantity, na.rm = TRUE)) %>%
  arrange(desc(total_quantity))

ggplot(df_gender_summary,
       aes(x = reorder(`Q.demos.gender`, -total_quantity),
           y = total_quantity,
           fill = `Q.demos.gender`)) +
  geom_col(alpha = 0.8) +
  geom_text(aes(label = total_quantity),
            vjust = -0.3, size = 4, color = "black") +
  scale_fill_manual(values = c("Male" = "#89CFF0", "Female" = "#FFC0CB")) +
  labs(
    title = "Distribution of Purchase Quantity by Gender",
    x = "Gender",
    y = "Total Quantity Purchased"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  )
```


## Age Pattern
```{r}
df_age_summary <- filt_quant %>%
  group_by(`Q.demos.age`) %>%
  summarise(Quantity = sum(Quantity, na.rm = TRUE))



ggplot(df_age_summary, aes(x = factor(`Q.demos.age`), y = Quantity)) +
  geom_col(fill = "steelblue", alpha = 0.9) +
  geom_text(aes(label = Quantity),
            vjust = -0.3, size = 3.5, color = "black") +
  labs(
    title = "Purchase Quantity by Age Group",
    x = "Age Group",
    y = "Total Quantity Purchased"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )
```


## Retention Analysis
```{r}
## RMF Calculation
filt_price$`Order.Date` <- as.Date(filt_price$`Order.Date`)

start_2022 <- as.Date("2022-01-01")
end_2022   <- as.Date("2022-12-31")

df_2022 <- filt_price %>%
  filter(`Order.Date` >= start_2022 & `Order.Date` <= end_2022)
latest_date_2022 <- max(df_2022$`Order.Date`, na.rm = TRUE)

rfm_2022 <- df_2022 %>%
  group_by(`Survey.ResponseID`) %>%
  summarise(
    Recency   = as.numeric(end_2022 - max(`Order.Date`, na.rm = TRUE)),  
    Frequency = n_distinct(`Order.Date`),                                
    Monetary  = sum(`Total.Price`, na.rm = TRUE)                         
  ) %>%
  mutate(
    R_score = ntile(-Recency, 5),
    F_score = ntile(Frequency, 5),
    M_score = ntile(Monetary, 5)
  )

head(rfm_2022)
```

```{r}
## Frequency VS Recency
ggplot(rfm_2022, aes(x = Recency, y = Frequency)) +
  geom_point(alpha = 0.5, color = "black", size = 2) +
  labs(
    title = "Frequency vs Recency",
    x = "Recency (Days Since Last Purchase)",
    y = "Frequency (Number of Purchases)",
    color = ""
  ) +
  coord_cartesian(ylim = c(0,80)) +
  theme_minimal(base_size = 13)
```
```{r}
## Recency VS Monetary
ggplot(rfm_2022, aes(x = Recency, y = Monetary)) +
  geom_point(alpha = 0.5, color = "black", size = 2) +
  labs(
    title = "Recency vs Monetary",
    x = "Recency (Days Since Last Purchase)",
    y = "Monetary (Total Spending)"
  ) +
  coord_cartesian(ylim = c(0, 4000)) +
  theme_minimal(base_size = 13)
```
```{r}
## Frequency VS Monetary
ggplot(rfm_2022, aes(x = Frequency, y = Monetary)) +
  geom_point(alpha = 0.5, color = "black", size = 2) +
  labs(
    title = "Frequency vs Monetary ",
    x = "Frequency (Number of Purchases)",
    y = "Monetary (Total Spnding)",
    color = ""
  ) +
  coord_cartesian(xlim = c(0,80), ylim = c(0, 4000)) +
  theme_minimal(base_size = 13) 
```
```{r}
## RFM Heatmap
rfm_heatmap <- rfm_2022 %>%
  group_by(R_score, F_score) %>%
  summarise(Avg_Monetary = mean(Monetary, na.rm = TRUE))

ggplot(rfm_heatmap, aes(x = F_score, y = R_score, fill = Avg_Monetary)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightyellow", high = "red") +
  theme_minimal() +
  labs(
    title = "RFM Heatmap (Avg Monetary by R & F Scores)",
    x = "Frequency Score",
    y = "Recency Score",
    fill = "Avg Spend ($)"
  )
```


## Combo Analysis
```{r}
df_combo <- df %>%
  mutate(
    cat_up   = toupper(Category),
    title_up = toupper(ifelse(is.na(Title), "", Title)),
    is_gift  = str_detect(cat_up, "^GIFT_CARD$|^ABIS_GIFT_CARD$|^ELECTRONIC_GIFT_CARD$"),
    is_env   = str_detect(cat_up, "^ENVELOPE$|^GIFT_WRAP$") |
               str_detect(title_up, "ENVELOPE|GIFT WRAP"),
    Year     = year(as.Date(`Order.Date`))
  )

person_year <- df_combo %>%
  group_by(`Survey.ResponseID`, Year) %>%
  summarise(
    has_gift = any(is_gift),
    has_env  = any(is_env),
    .groups = "drop"
  ) %>%
  mutate(group = case_when(
    has_gift & has_env ~ "Both",
    has_gift & !has_env ~ "Gift Card Only",
    !has_gift & has_env ~ "Envelope Only",
    TRUE ~ "Neither"
  )) %>%
  filter(group != "Neither") 


counts <- person_year %>%
  filter(group != "Neither") %>%
  count(Year, group) %>%
  group_by(Year) %>%
  mutate(prop = prop.table(n)) %>%
  ungroup()

```

```{r}
ggplot(counts, aes(y = factor(Year), x = prop, fill = group)) +
  geom_col(color = "white", linewidth = 0.8) +
  geom_text(aes(label = percent(prop, accuracy = 1)),
            position = position_stack(vjust = 0.5),
            size = 3.5) +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_manual(
    values = c(
      "Gift Card Only" = "#ffd14f",
      "Both"           = "#4ba761",
      "Envelope Only"  = "#2882fb"
    ),
    name = "Purchase Group"
  ) +
  labs(
    title = "Distribution of Gift Card Purchase Pattern",
    subtitle = "Among same-year buyers",
    x = "% of people",
    y = "Year"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "bottom"
  )
```
